import os
import logging
import random
import time
import subprocess

logger = logging.getLogger("timeflux")

try:
	version = subprocess.check_output(["git", "describe", "--tags"]).strip().decode()
	logger.info(f"Application version: {version}")
except:
	pass

codes = [
	"000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000",
	"001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000",
	"000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000",
	"000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000",
	"100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000",
	"000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000",
	"000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000",
	"000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000",
	"000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000",
	"000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000",
	"000000000000000000001000000000000000000000100000000000000000000010000000000000000000001000000000000000000000100000000000000000000010",
]

def gen_code(length=132, bursts=6, jitter=3, offset=0):
	code = ["0"] * length
	for frame in range(offset, length, int(length / bursts)):
		frame += random.randint(-jitter, jitter)
		if frame < 0: frame = 0
		if frame > length - 1: frame = length - 1
		code[frame] = "1"
	code = "".join(code)
	return code

def gen_codes(n, length=132, bursts=6, jitter=3):
	codes = []
	offset = length / bursts / n
	for i in range(n):
		codes.append(gen_code(length, bursts, jitter, round(offset * i)))
	random.shuffle(codes)
	return codes

def get_codes(layout):
	if layout == "single":
		#return code[0]
		return gen_code(offset=10)
	if layout == "simple":
		#return " ".join(codes[0:5])
		return " ".join(gen_codes(5))
	if layout == "grid":
		#return " ".join(codes[0:9])
		return " ".join(gen_codes(9))
	if layout == "keyboard":
		#return " ".join(codes)
		return " ".join(gen_codes(11))

# For reproducibility
seed = os.getenv("SEED", time.time_ns())
logger.info(f"Random seed: {seed}")
random.seed(seed)

os.environ["CALIBRATION_CODES"] = get_codes(os.getenv("CALIBRATION_LAYOUT", "single"));
os.environ["TASK_CODES"] = get_codes(os.getenv("TASK_LAYOUT", "simple"));
